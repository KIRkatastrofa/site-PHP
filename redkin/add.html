<?php
	session_start();
	if( !isset($_SESSION['LogIn']) ) 
	{
		header("Location: aut.html");
		exit(1);
	}
	require_once "mysqli.php";
	db_connect();
	$login=$_SESSION['user'];
	$qw="SELECT status FROM users WHERE login='$login'";
	$res=mysqli_query($conn,$qw);
	while($rowr = mysqli_fetch_assoc($res))
	{
		$status=$rowr['status'];
	}
	if($status=="root" || $status=="admin") 
	{
	}
	else
	{
		header("Location: index.html");
		exit(1);
	}
	db_close();
	
$namepr=$_POST['namepr'];
$category=$_POST['category'];
if($category=="Сады")
		{
		$category="gardens";
		}
		else if($category=="Электроника")
		{
		$category="electronics";
		}
		else if($category=="Водопровод")
		{
		$category="plumbing";
		}
		else if($category=="Инструменты")
		{
		$category="tools";
		}
$price=$_POST['price'];
$description=$_POST['description'];
$properties=$_POST['properties'];
$num=$_POST['status'];

if(!empty($_POST))
{
	$key=0;
	db_connect();
	$query1 = "SELECT namepr FROM product";
	$search = mysqli_query($conn, $query1);
	while($row = mysqli_fetch_assoc($search))
	{
		//проверка на логин
		if($row["namepr"]==$namepr)
		{
			$key=1;
		}
	}
	if($key==0)
	{	
		//---картинка
		if ( is_uploaded_file($_FILES["img"]["tmp_name"])) {
			$tmpPath = $_FILES["img"]["tmp_name"];
			$toBuffer = file_get_contents($tmpPath);
			$type = mime_content_type($tmpPath);
			$img = "data:$type;base64," . base64_encode($toBuffer);
		}
		//
		$salt = sha1(uniqid() . mt_rand());
		$hashpas =sha1($salt . $passw);
		if($namepr!=null && $category!=null && $price!=null && $description!=null && $properties!=null && $num!=null)
		{
		$query = "INSERT INTO product (namepr, category, price, description, img, properties, status) VALUES ('$namepr','$category',$price,'$description','$img','$properties','$num')";
		$result = mysqli_query($conn, $query);
		echo "Товар добавлен!"."<br>";
		}
		else
		{
			echo "Заполните все поля!"."<br>";
		}
	}
		else 
	{
		echo "Продукт с таким названием уже существует!"."<br>";
	}
	db_close();
}
?>
<html lang="ru">
<head>
	<meta charset="utf-8">
	<title>Добавление товара</title>	
</head>
<body>
	<?php 
		require_once "blocks/header.php";
	?>
<form method="POST" enctype="multipart/form-data">
	<input type="text" id="n2" name="namepr" placeholder="Название товара" maxlength=20>
	<label for="n2"><span></span>Название</label><br>
	<select id="n3" name="category" maxlength=10>
		<option>Сады</option>
		<option>Электроника</option>
		<option>Водопровод</option>
		<option>Инструменты</option>
	</select>
	<label for="n3"><span></span>Категория</label><br>
	<input type="number" id="n4" name="price" placeholder="Цена" maxlength=7>
	<label for="n4"><span></span>Цена</label><br>
	<input type="text" id="n5" name="description" placeholder="Описание" maxlength=100>
	<label for="n5"><span></span>Описание</label><br>
	<input type="file" id="n6" name="img" placeholder="Картинка" accept="image/jpeg,image/png,image/jpg">
	<label for="n6"><span></span>Картинка</label><br>
	<input type="text" id="n7" name="properties" placeholder="Свойства" maxlength=100>
	<label for="n7"><span></span>Свойства</label><br>
	<input type="number" id="n8" name="status" placeholder="Количество" maxlength=10>
	<label for="n8"><span></span>Количество</label><br>
	<input type="submit" id="n4" placeholder="Добавить" value="Добавить">
</form>
<?php 
		require_once "blocks/footer.php";
	?>
</body>